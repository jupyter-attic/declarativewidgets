<link rel="import" href="../../../bower_components/app-route/app-route.html">
<link rel="import" href="../../../bower_components/app-route/app-location.html">
<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/iron-component-page/iron-component-page.html">
<link rel="import" href="../../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../../bower_components/marked-element/marked-element.html">
<link rel="import" href="../../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">

<dom-module id='urth-docs-panel'>
    <template>
        <style>
            .iron-selected.selectable {
                background: #fafafa;
                color: #000000;
            }

            .project-name {
                font-weight: 200;
                letter-spacing: 0px;
                letter-spacing: 0.05rem;
                text-decoration: none;
                color: #ffffff;
            }

            .selectable {
                color: #D0D0D0;
                font-size: 14px;
                font-family: "Helvetica Neue",Arial,sans-serif;
                height: 28px;
                line-height: 28px;
                padding-left: 20px;
                -webkit-font-smoothing: antialiased;
            }

            .selectable:hover:not(.iron-selected) {
                cursor: pointer;
                background: #4E4E4E;
            }

            .selector-header {
                font-size: 14px;
                font-weight: 400;
                line-height: 24px;
                font-family: "Helvetica Neue",Arial,sans-serif;
                -webkit-box-align: center;
                -webkit-align-items: center;
                -ms-flex-align: center;
                align-items: center;
                min-height: 28px;
                display: -ms-flexbox;
                display: -webkit-flex;
                display: -webkit-box;
                display: flex;
                -ms-flex-direction: row;
                -webkit-flex-direction: row;
                -webkit-box-orient: horizontal;
                -webkit-box-direction: normal;
                flex-direction: row;
                margin: 8px 0 4px 8px;
                color: #888;
            }

            .top-nav-item {
                color: #000000;
                font-weight: 200;
                letter-spacing: 1px;
                letter-spacing: 0.1rem;
                margin-left: auto;
                text-decoration: none;
            }

            .doc-container {
                padding: 20px;
                margin: 0 auto;
                max-width: 48em;
            }

            .doc-heading {
                color: #424242;
                font-family: 'Roboto','Noto',sans-serif;
                -webkit-font-smoothing: antialiased;
                white-space: nowrap;
                font-size: 20px;
                font-weight: 500;
                line-height: 28px;
            }

            .urth-docs {
                font-family: 'Roboto','Noto',sans-serif;
                -webkit-font-smoothing: antialiased;
                font-size: 14px;
                font-weight: 400;
                line-height: 20px;
                color: #212121;
            }

            .urth-docs code {
                font-family: 'Roboto Mono','Consolas','Menlo',monospace;
                -webkit-font-smoothing: antialiased;
                font-size: 14px;
                font-weight: 500;
                line-height: 20px;
                background: #eeeeee;
                padding: 3px;
                border-radius: 3px;
            }

            .urth-docs blockquote {
                padding: 0 15px;
                color: #777;
                border-left: 4px solid #ddd;
            }

            .urth-docs pre {
                background-color: #eeeeee;
                border-radius: 3px;
                font-size: 15px;
                overflow-x: auto;
                padding: 12px 24px;
                word-wrap: break-word;
            }

            paper-header-panel[drawer] {
                --paper-header-panel-waterfall-container: {
                    background: #343131;
                 };
            }

            paper-header-panel[main] {
                --paper-header-panel-waterfall-container: {
                    background: #fafafa;
                 };
            }

            paper-toolbar {
                --paper-toolbar: {
                    font-family: "Helvetica Neue",Arial,sans-serif;
                    font-size: 16px;
                    font-weight: 400;
                };
            }

            paper-toolbar.elementbar {
                --paper-toolbar-background: #2980B9;
                --paper-toolbar-color: #ffffff;
            }

            paper-toolbar.navbar {
                --paper-toolbar-background: #fafafa;
                --paper-toolbar-color: #000000;
            }
        </style>

        <app-location route="{{route}}" use-hash-as-path></app-location>
        <app-route route="{{route}}" pattern=":docEle" data="{{routeData}}"></app-route>

        <paper-drawer-panel id="drawerPanel">
            <paper-header-panel drawer mode="waterfall">
                <paper-toolbar class="elementbar">
                    <a class="project-name" href$="[[homeUrl]]">Jupyter Declaritive Widgets</a>
                </paper-toolbar>
                <iron-selector id="selector" attr-for-selected="name" selectable=".selectable" selected="{{docSelected}}">
                    <div class="selector-header">Usage</div>
                    <template is="dom-repeat" items="[[urthDocs]]">
                        <div class="selectable" name="[[item.title]]">[[item.title]]</div>
                    </template>
                    <div class="selector-header">Elements</div>
                    <template is="dom-repeat" items="[[elementDescriptors]]">
                        <div class="selectable" name="[[item.is]]">[[item.is]]</div>
                    </template>
                    <div class="selector-header">Behaviors</div>
                    <template is="dom-repeat" items="[[behaviorDescriptors]]">
                        <div class="selectable" name="[[item.is]]">[[item.is]]</div>
                    </template>
                </iron-selector>
            </paper-header-panel>
            <paper-header-panel id="contentHeaderPanel" main mode="waterfall">
                <paper-toolbar class="navbar">
                    <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
                    <template is="dom-if" if="[[repositoryUrl]]">
                        <a class="top-nav-item" href$="[[repositoryUrl]]">Repository</a>
                    </template>
                </paper-toolbar>
                <div class="doc-container">
                    <template is="dom-if" if="[[isMarkdown]]">
                        <h2 class="doc-heading">[[docSelected]]</h2>
                        <iron-ajax auto url="[[markdownURL]]" handle-as="text" last-response="{{markdownDocContent}}"></iron-ajax>
                        <marked-element markdown="[[markdownDocContent]]">
                            <div class="markdown-html urth-docs"></div>
                        </marked-element>
                    </template>
                    <template is="dom-if" if="[[!isMarkdown]]">
                        <h2 class="doc-heading">[[docSelected]]</h2>
                        <iron-doc-viewer descriptor="[[docDescriptor]]" on-iron-doc-viewer-component-selected="_handleComponentSelectedEvent"></iron-doc-viewer>
                    </template>
                </div>
            </paper-header-panel>
        </paper-drawer-panel>
        <iron-component-page id="ironComponentPage" catalog doc-elements="{{elementDescriptors}}"
                        doc-behaviors="{{behaviorDescriptors}}" doc-src="[[docSrc]]" style="display:none;">
        </iron-component-page>
    </template>

    <script>
    Polymer({
        is: 'urth-docs-panel',
        properties: {
            /**
             * Data rows for table. Must be an Array of Arrays
             *
             * @attribute datarows
             * @type Array
             */
            urthDocs: {
                type: Array
            },
            docSrc: {
                type: String
            },
            repositoryUrl: {
                type: String
            },
            homeUrl: {
                type: String,
                value: '.'
            },
            isMarkdown: {
                type: Boolean,
                computed: 'isDocMarkdown(docSelected)'
            },
            docSelected: {
                observer: '_docSelectedChanged'
            }
        },

        observers: [
            'loadDocFromPath(routeData, elementDescriptors, behaviorDescriptors)'
        ],

        // we're observing on the change on routeData, in condition that both elementDescriptors and 
        // behaviorDescriptors are not empty
        loadDocFromPath: function(routeData, elementDescriptors, behaviorDescriptors) {
            if (elementDescriptors.length === 0 || behaviorDescriptors.length === 0) { return; }

            var docEle = routeData.docEle;

            // if route given has no doc element speicified, we use the first usage doc by default
            // and switch the route to the path of that doc
            if (!docEle) {
                docEle = this.urthDocs[0].url;
                this.route = { path: docEle, prefix: "" };
            }

            // check wether this doc is a markdown doc (usage doc),
            // or a doc generated by hydrolysis in iron-component-page
            // by checking if it's in this.urthDocs
            var docTitle;
            this.urthDocs.some(function(docObj) {
                if(docObj.url === docEle) {
                    docTitle = docObj.title;
                    return;
                }
            });
            this.docSelected = docTitle || docEle; // If is mark down, use docTitle. Else, use docEle
        },

        findDocFileByDocTitle: function(docTitle) {
            var docFile = null;
            this.urthDocs.some(function(docObj) {
                if(docObj.title === docTitle) {
                    docFile = docObj.file;
                }
            });
            return docFile;
        },

        findDocUrlByDocTitle: function (docTitle) {
            var docUrl = null;
            this.urthDocs.some(function(docObj) {
                if(docObj.title === docTitle) {
                    docUrl = docObj.url;
                }
            });
            return docUrl;
        },

        ready: function() {
            this.$.selector.addEventListener('iron-activate', function() {
                if (this.$.drawerPanel.narrow) {
                    this.$.drawerPanel.closeDrawer();
                }
            }.bind(this));

            this.$.selector.addEventListener('iron-select', function() {
                if (!this.$.drawerPanel.narrow) {
                    // if the selected doc label is not visible on screen, we need to scroll it into view
                    if (this.$.selector.selectedItem.getBoundingClientRect().bottom > window.innerHeight) {
                        this.$.selector.selectedItem.scrollIntoView();
                    }
                }
            }.bind(this));
        },

        isDocMarkdown: function(doc) {
            return this.findDocFileByDocTitle(doc) !== null;
        },

        _docSelectedChanged: function(docSelected) {
            if (!docSelected) { return; }
            if (!this.isDocMarkdown(docSelected)) {
                this.docDescriptor = null;
                for (var i = 0; i < this.$.ironComponentPage.docElements.length; i++) {
                    if (this.$.ironComponentPage.docElements[i].is === docSelected) {
                        this.docDescriptor = this.$.ironComponentPage.docElements[i];
                        break;
                    }
                }
                for (var i = 0; i < this.$.ironComponentPage.docBehaviors.length; i++) {
                    if (this.$.ironComponentPage.docBehaviors[i].is === docSelected) {
                        this.docDescriptor = this.$.ironComponentPage.docBehaviors[i];
                        break;
                    }
                }

                // update routeData to change the current url
                this.routeData = { docEle: docSelected };
            } else {
                this.markdownURL = '../../' + this.findDocFileByDocTitle(docSelected);

                // update routeData to change the current url
                this.routeData = { docEle: this.findDocUrlByDocTitle(docSelected) };
            }

            // scroll doc content pane back to top
            this.$.contentHeaderPanel.scroller.scrollTop = 0;
        },

        _handleComponentSelectedEvent: function(ev) {
            this.docSelected = ev.detail;
        }
    });
    </script>
</dom-module>
